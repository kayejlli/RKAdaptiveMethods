MODULE rk109LegendreMod

USE GlobalCommonMod
USE DyDtMod

IMPLICIT NONE
PRIVATE

!  Define access to SUBROUTINEs.

PUBLIC :: rk109LegendreEachStep
! downloaded from http://www.peterstone.name/Maplepgs/Maple/nmthds/RKcoeff/Runge_Kutta_schemes/RK10/RKcoeff10r_1.pdf
! k[i] are the nodes 
REAL(KIND=8), PARAMETER, PRIVATE :: &
 k0=0.0D0,&
 k1=2.50965250965250965250965250965250965250965250965250965250965D-2,&
 k2=8.73709837387022551595215793807425737683965927909620488393555D-2,&
 k3=0.131056475608053382739282369071113860652594889186443073259033D0,&
 k4=0.548589341692789968652037617554858934169278996865203761755486D0,&
 k5=0.701098646495456473990057236650528095284903034370734449189816D0,&
 k6=0.294604527785723068683225500966313941017737016705002926687327D0,&
 k7=0.82975264523431628556106894801403503025220004256311447989762D0,&
 k8=0.622314483925737214170801711010526272689150031922335859923215D0,&
 k9=0.117718446601941747572815533980582524271844660194174757281553D0,&
 k10=0.387931034482758620689655172413793103448275862068965517241379D0,&
 k11=0.642615758240322548157075497020439535959501736363212695909875D0,&
 k12=0.117472338035267653574498513020330924817132155731947880336209D0,&
 k13=0.882527661964732346425501486979669075182867844268052119663791D0,&
 k14=0.357384241759677451842924502979560464040498263636787304090125D0,&
 k15=0.642615758240322548157075497020439535959501736363212695909875D0,&
 k16=0.882527661964732346425501486979669075182867844268052119663791D0,&
 k17=1.0D0,&
 k18=0.231578947368421052631578947368421052631578947368421052631579D0,&
 k19=0.8D0,&
 k20=1.0D0
! a[i,j] 
REAL(KIND=8), PARAMETER, PRIVATE :: &
 a1_0=2.50965250965250965250965250965250965250965250965250965250965D-2,&
 a2_0=-6.47155854199408710197377852460533449079754938682991391977923D-2,&
 a2_1=0.152086569158643126179259364626795918676372086659261188037148D0,&
 a3_0=3.27641189020133456848205922677784651631487222966107683147583D-2,&
 a3_1=0.0D0,&
 a3_2=9.82923567060400370544617768033353954894461668898323049442749D-2,&
 a4_0=2.4842897474365236364976826232593553478016335010413833382917D0,&
 a4_1=0.0D0,&
 a4_2=-9.25161165926732911641181838830684838012753710966861174568295D0,&
 a4_3=7.31591125352359544856617338260235196649518260549243216914673D0,&
 a5_0=-2.44447574091266316607680904935093643131927676302626242985254D-2,&
 a5_1=0.0D0,&
 a5_2=0.0D0,&
 a5_3=0.364655658574625998723140979591779448656135314599202980263918D0,&
 a5_4=0.360887745329957106927684347552258010941960487401794093224424D0,&
 a6_0=1.8585598247413188173374585488021906396992100867167630999719D-2,&
 a6_1=0.0D0,&
 a6_2=0.0D0,&
 a6_3=0.253991360185707876451155087314116208390261071485584525289852D0,&
 a6_4=3.49801454442855497411094138468017301260214819630411524829311D-2,&
 a6_5=-1.29525760916835456824135856826259038955376376107903820851743D-2,&
 a7_0=9.219473835936847617345210533489278113913333806256827554418D-2,&
 a7_1=0.0D0,&
 a7_2=0.0D0,&
 a7_3=0.0D0,&
 a7_4=0.0D0,&
 a7_5=0.312321436950010931734526235827874714241649183130032612940263D0,&
 a7_6=0.425236469924936877653090606851267534871417521370513591413177D0,&
 a8_0=9.23748062077266177284783789781249936022957078634717292073522D-2,&
 a8_1=0.0D0,&
 a8_2=0.0D0,&
 a8_3=0.0D0,&
 a8_4=0.0D0,&
 a8_5=0.149894497517665957282970174595619645983502479465493311152733D0,&
 a8_6=0.423801667351373037030737652742209261651807706212910059713981D0,&
 a8_7=-4.3756487151028397871384495305427628548455861619539240150851D-2,&
 a9_0=7.48299144286057798179645788177940376654165341803150717127009D-2,&
 a9_1=0.0D0,&
 a9_2=0.0D0,&
 a9_3=0.0D0,&
 a9_4=0.0D0,&
 a9_5=0.214624245334461145513220307733401580553167691197459584145791D0,&
 a9_6=8.44158728153289950943823344278516215586213577652245964916067D-2,&
 a9_7=-4.34173144988408831425824450505105912818808675891516298334216D-2,&
 a9_8=-0.212734271477613289710169241947954124223480055359672865235123D0,&
 a10_0=8.10531913521313798244909749494660531869967953489542680476453D-2,&
 a10_1=0.0D0,&
 a10_2=0.0D0,&
 a10_3=0.0D0,&
 a10_4=0.0D0,&
 a10_5=0.307234790278631472378275084084832700081365749012943070959457D0,&
 a10_6=0.322133065353754573534535870413143837736357822099441148699877D0,&
 a10_7=-6.22222589172587979244108601231457879907545644829384433242744D-2,&
 a10_8=-0.302798873916450214592115564960296230686021890116903406809375D0,&
 a10_9=4.25311203319502074688796680497925311203319502074688796680498D-2,&
 a11_0=2.83544828539198031219718026492047083720913246218057266817897D-2,&
 a11_1=0.0D0,&
 a11_2=0.0D0,&
 a11_3=0.0D0,&
 a11_4=0.0D0,&
 a11_5=0.0D0,&
 a11_6=0.0D0,&
 a11_7=-3.03663977681048586970335756302792929752497061103029873205057D-3,&
 a11_8=0.110413075360036756537163021359543320733546112986836942674426D0,&
 a11_9=0.208542653267650952869213647815667778879632512725104539063034D0,&
 a11_10=0.298342186535525521498430382759051657271756756640495786222676D0,&
 a12_0=4.50261637325837808957158526694306726419110564755889107042664D-2,&
 a12_1=0.0D0,&
 a12_2=0.0D0,&
 a12_3=0.0D0,&
 a12_4=0.0D0,&
 a12_5=0.0D0,&
 a12_6=0.0D0,&
 a12_7=2.9315743190881918810252490084282814289469563169305552453607D-3,&
 a12_8=0.130921369907446674489691795245945599918757671581828224884979D0,&
 a12_9=8.36925945425160159146534334904179792974378191252684890008372D-2,&
 a12_10=-2.50666966117596770423266357290386586034424439924441058992183D-2,&
 a12_11=-0.120032667854607332564261181664852949866478903775224193600017D0,&
 a13_0=2.68255902704955741492632530381675841057064536997271503852792D-2,&
 a13_1=0.0D0,&
 a13_2=0.0D0,&
 a13_3=0.0D0,&
 a13_4=0.0D0,&
 a13_5=0.0D0,&
 a13_6=0.0D0,&
 a13_7=0.126382102849998327046201735916914766100613218231229082577707D0,&
 a13_8=-0.168425375623755278873404722589778537587120117205634760902934D0,&
 a13_9=-1.7844036697247706422018348623853211009174311926605504587156D0,&
 a13_10=0.306103458361993036119897659696947897967512783242502926384377D0,&
 a13_11=0.383829951971853583457929486423216239171698951753506955132829D0,&
 a13_12=1.99221560385891774672744893687952222634188774720727122480213D0,&
 a14_0=2.4646447165738675134756922741080751501035084424738717359814D-2,&
 a14_1=0.0D0,&
 a14_2=0.0D0,&
 a14_3=0.0D0,&
 a14_4=0.0D0,&
 a14_5=0.0D0,&
 a14_6=0.0D0,&
 a14_7=1.64934510092410051169464285389957227863262082852864627368593D-2,&
 a14_8=-0.270128739020109789006947949052373120824374177521583618130373D0,&
 a14_9=-0.450734008331773888195751847093292858523056233041116419787158D0,&
 a14_10=0.16020249683720199259609302040114027341285968716925675459238D0,&
 a14_11=0.219633923431899195115422576915157356584249394407701370075766D0,&
 a14_12=0.669240870797768870847333199871974769470164884424458016730097D0,&
 a14_13=-1.1970200130288609764927849343122430366706584511953979487261D-2,&
 a15_0=6.3526446307904905723473304951266862903366651640383560573669D-2,&
 a15_1=0.0D0,&
 a15_2=0.0D0,&
 a15_3=0.0D0,&
 a15_4=0.0D0,&
 a15_5=0.0D0,&
 a15_6=0.0D0,&
 a15_7=-0.158289348008007483591596745708985447554397795436708724383551D0,&
 a15_8=0.609509894839373381659515767382010584152236953542761869060089D0,&
 a15_9=2.44043349957860364617695407175350644795901091417624326356389D0,&
 a15_10=-1.29013110747012311610943140622867301583756968464723289623316D0,&
 a15_11=-0.259489856629947471304200036429850604979207342489326318508526D0,&
 a15_12=-2.35044995355213220663993237578301343596051925388112373568494D0,&
 a15_13=8.99277369634835584643043830611118122341463259828585430092442D-2,&
 a15_14=1.49757844621116733377798853402306633304243496747535713451317D0,&
 a16_0=-9.00767086456658057746826622199214039622271983285821399971791D-3,&
 a16_1=0.0D0,&
 a16_2=0.0D0,&
 a16_3=0.0D0,&
 a16_4=0.0D0,&
 a16_5=0.0D0,&
 a16_6=0.0D0,&
 a16_7=0.284553847889263828444049769145324191142370790153549483364008D0,&
 a16_8=-0.676906134381500924616341654582960153745164614446433556764929D0,&
 a16_9=-4.05825817390809334878556407061724930036462003791283881407203D0,&
 a16_10=1.92444297542206549279191637642476778780301833881364450141758D0,&
 a16_11=-8.89458644070626791492428931653343612953401007820794917520909D-2,&
 a16_12=4.38685834482268298555577012655254802008387295776923429878733D0,&
 a16_13=-9.16185440176948223667141409238791747068625171419223669392006D-2,&
 a16_14=-1.52573567874685081821765347035213565182116455616907050581614D0,&
 a16_15=0.737144560156489213346749710720579858482980303816826785438982D0,&
 a17_0=0.10631750834676978409074896488190947430729018482481133718601D0,&
 a17_1=0.0D0,&
 a17_2=0.0D0,&
 a17_3=0.0D0,&
 a17_4=0.0D0,&
 a17_5=0.0D0,&
 a17_6=0.0D0,&
 a17_7=-0.649035030624980805056013202991415574848617035968315552278744D0,&
 a17_8=0.908602375570137662237054766099089613579903023254455657954303D0,&
 a17_9=8.83747916632153155713271309143807834901295042088340899640002D0,&
 a17_10=-3.39531550492577752216877800949166950285299353090683013415003D0,&
 a17_11=0.583490938201010599453639234147986457491410309323073155685681D0,&
 a17_12=-8.88593593247083239344438824646889621716830737462044678260816D0,&
 a17_13=0.318915269245533436902456021348675301954046478564116324204778D0,&
 a17_14=3.44722703652775671815647501032432215527703592405139288057053D0,&
 a17_15=-0.60519836122192778322417076712956071278148204997152936137614D0,&
 a17_16=0.333452535030778745920263137841480656028763650565863478411751D0,&
 a18_0=3.23552803925102999936248322986404255196342688922119433461864D-3,&
 a18_1=0.0D0,&
 a18_2=0.0D0,&
 a18_3=0.0D0,&
 a18_4=0.0D0,&
 a18_5=-0.237827090784149163599831088926299429175387866725731383462253D0,&
 a18_6=-0.33950434377088736082270175073851717879403109114165212902041D0,&
 a18_7=0.18283353799884051858400499487132903163882743161206965623768D0,&
 a18_8=-0.594387714640970678645210602105144304202192554426508884863596D0,&
 a18_9=-3.10571970927524023219721406339226185510593146664207066679123D0,&
 a18_10=0.373579231628163609949463965291933153637148683151292643118824D0,&
 a18_11=0.645790413428509686034587400886428038063415069782930059574693D0,&
 a18_12=3.39590325392559445434168885806413913419195326633672631904084D0,&
 a18_13=-9.23241591806908110125712498130495801741859514678557555375887D-2,&
 a18_14=0.0D0,&
 a18_15=0.0D0,&
 a18_16=0.0D0,&
 a18_17=0.0D0,&
 a19_0=-0.631387384158912916794748624349655010920355926180095508270159D0,&
 a19_1=0.0D0,&
 a19_2=0.0D0,&
 a19_3=0.0D0,&
 a19_4=0.0D0,&
 a19_5=0.424591375983125501781440445092295860917388648013656389400188D0,&
 a19_6=-3.22505384319727354877751646370848120034665872472245029910543D0,&
 a19_7=1.12750250338831752177909066146349115170400337858985004816543D0,&
 a19_8=2.55622538790871514998878369844657637274997623632199890022473D0,&
 a19_9=-3.50356346654893541169434897474688968332711379996437260006034D0,&
 a19_10=4.13182606526140890893583333318250797508326689165582853155221D0,&
 a19_11=-4.01889476035829204078122182353178244747189416928341972726793D0,&
 a19_12=6.26769944474310381842272596181458766468121321534598781669811D0,&
 a19_13=-0.550980811401095827342278351748814033817854934399063729883809D0,&
 a19_14=0.0D0,&
 a19_15=0.0D0,&
 a19_16=0.0D0,&
 a19_17=0.0D0,&
 a19_18=-1.777964511620161155517759861913836649251970815377919821453D0,&
 a20_0=-0.214491783041091520607536169321900131029860549362794304179895D0,&
 a20_1=0.0D0,&
 a20_2=0.0D0,&
 a20_3=0.0D0,&
 a20_4=0.0D0,&
 a20_5=0.64715324225269277075434922502171646731915146169304597962862D0,&
 a20_6=-0.968085111355090482522303176495945645035518320229052655062746D0,&
 a20_7=0.240757934523921354861149834616315437616119545103222674769456D0,&
 a20_8=-0.895296129609453103757629004460702444427451002783205778367447D0,&
 a20_9=3.23529411764705882352941176470588235294117647058823529411765D0,&
 a20_10=2.04097938458294746532399560570952677652045227747397679575646D0,&
 a20_11=3.8241613012098266661720623987652958497651554106460815005275D-2,&
 a20_12=-1.96186770902884239097394741967697617080779036941064831801498D0,&
 a20_13=0.2D0,&
 a20_14=0.0D0,&
 a20_15=0.0D0,&
 a20_16=0.0D0,&
 a20_17=0.0D0,&
 a20_18=-1.11852051265556038014961309821725639373494006169847370098324D0,&
 a20_19=-0.244165046328680803119598185868313207858991005480766802669141D0
! b[i] are coefficients for nodes k[i] 
REAL(KIND=8), PARAMETER, PRIVATE :: &
 b0=3.33333333333333333333333333333333333333333333333333333333333D-2,&
 b1=0.0D0,&
 b2=0.0D0,&
 b3=0.0D0,&
 b4=0.0D0,&
 b5=0.0D0,&
 b6=0.0D0,&
 b7=0.0D0,&
 b8=0.0D0,&
 b9=0.0D0,&
 b10=0.0D0,&
 b11=0.138714594258871588254180131280327170214252159859020418169736D0,&
 b12=0.189237478148923490158306404106012326238162346948625830327194D0,&
 b13=9.46187390744617450791532020530061631190811734743129151635972D-2,&
 b14=0.277429188517743176508360262560654340428504319718040836339472D0,&
 b15=0.138714594258871588254180131280327170214252159859020418169736D0,&
 b16=9.46187390744617450791532020530061631190811734743129151635972D-2,&
 b17=3.33333333333333333333333333333333333333333333333333333333333D-2,&
 b18=0.0D0,&
 b19=0.0D0,&
 b20=0.0D0,&
 b_0=3.42710358868521288537605937643830529038352965517831863650625D-2,&
 b_1=0.0D0,&
 b_2=0.0D0,&
 b_3=0.0D0,&
 b_4=0.0D0,&
 b_5=0.0D0,&
 b_6=0.0D0,&
 b_7=0.0D0,&
 b_8=-0.379682985551263338337260245949950699416584020366879604223474D0,&
 b_9=-0.10072210818311519237850610045372791252857351743944038426066D0,&
 b_10=0.27617975329176119359544601222887632210877898216665391545115D0,&
 b_11=0.649046284543191632397980155844266012174237741403393179208841D0,&
 b_12=0.279958575903000873586365627231631528628840023734876443850473D0,&
 b_13=0.204062667833002676057298796973031129745186548509524891780655D0,&
 b_14=0.0D0,&
 b_15=0.0D0,&
 b_16=0.0D0,&
 b_17=0.0D0,&
 b_18=4.39803426339170250148119056292493745361546020097929645954801D-2,&
 b_19=-3.92165547702015926205191449867060066927078080103267549772553D-2,&
 b_20=3.21229884128545938306223997189471985408321514406221622097274D-2


CONTAINS

SUBROUTINE rk109LegendreEachStep(t,y0,yn,h,hnew,rerun,test)
 REAL(KIND=8), INTENT(IN) :: t
 REAL(KIND=8), DIMENSION(:), INTENT(IN) :: y0     ! y(t)
 REAL(KIND=8), DIMENSION(SIZE(y0)), INTENT(OUT) :: yn ! y(t+h)
 REAL(KIND=8), INTENT(IN) :: h ! initial step size
 REAL(KIND=8), INTENT(OUT) :: hnew       ! new step size
 LOGICAL, INTENT(OUT) :: test, rerun ! test=stop the program, rerun=re-run this step, reject
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: tolh ! the tolerance, determined by the problem
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: yerr ! the error between embedded method
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: ynp  ! the embedded
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: ymax ! the max value among y0 and yn
 REAL(KIND=8) :: err
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: y1,y2,y3,y4,y5,y6,y7,y8,y9, &
                                      y10,y11,y12,y13,y14,y15,y16,y17,y18, &
                                      y19,y20
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: dy0,dy1,dy2,dy3,dy4,dy5,dy6,dy7,dy8, &
                                      dy9,dy10,dy11,dy12,dy13,dy14,dy15,dy16,dy17, &
                                      dy18,dy19,dy20
 INTEGER :: i
  test = .False.
  rerun = .False. 
  ! use y0 to get dy0
  CALL  dev(t,y0,dy0,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y1=y0+h*(a1_0*dy0)
  ! use y1 to get dy1
  CALL  dev(t,y1,dy1,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y2=y0+h*(a2_0*dy0+a2_1*dy1)
  ! use y2 to get dy2
  CALL  dev(t,y2,dy2,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y3=y0+h*(a3_0*dy0+a3_1*dy1+a3_2*dy2)
  ! use y3 to get dy3
  CALL  dev(t,y3,dy3,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y4=y0+h*(a4_0*dy0+a4_1*dy1+a4_2*dy2+a4_3*dy3)
  ! use y4 to get dy4
  CALL  dev(t,y4,dy4,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y5=y0+h*(a5_0*dy0+a5_1*dy1+a5_2*dy2+a5_3*dy3+a5_4*dy4)
  ! use y5 to get dy5
  CALL  dev(t,y5,dy5,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y6=y0+h*(a6_0*dy0+a6_1*dy1+a6_2*dy2+a6_3*dy3+a6_4*dy4+a6_5*dy5)
  ! use y6 to get dy6
  CALL  dev(t,y6,dy6,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y7=y0+h*(a7_0*dy0+a7_1*dy1+a7_2*dy2+a7_3*dy3+a7_4*dy4+a7_5*dy5 + &
        &  a7_6*dy6)
  ! use y7 to get dy7
  CALL  dev(t,y7,dy7,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y8=y0+h*(a8_0*dy0+a8_1*dy1+a8_2*dy2+a8_3*dy3+a8_4*dy4+a8_5*dy5 + &
        &  a8_6*dy6+a8_7*dy7)
  ! use y8 to get dy8
  CALL  dev(t,y8,dy8,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y9=y0+h*(a9_0*dy0+a9_1*dy1+a9_2*dy2+a9_3*dy3+a9_4*dy4+a9_5*dy5 + &
        &  a9_6*dy6+a9_7*dy7+a9_8*dy8)
  ! use y9 to get dy9
  CALL  dev(t,y9,dy9,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y10=y0+h*(a10_0*dy0+a10_1*dy1+a10_2*dy2+a10_3*dy3+a10_4*dy4+a10_5*dy5 + &
         &  a10_6*dy6+a10_7*dy7+a10_8*dy8+a10_9*dy9)
  ! use y10 to get dy10
  CALL  dev(t,y10,dy10,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y11=y0+h*(a11_0*dy0+a11_1*dy1+a11_2*dy2+a11_3*dy3+a11_4*dy4+a11_5*dy5 + &
         &  a11_6*dy6+a11_7*dy7+a11_8*dy8+a11_9*dy9+a11_10*dy10)
  ! use y11 to get dy11
  CALL  dev(t,y11,dy11,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y12=y0+h*(a12_0*dy0+a12_1*dy1+a12_2*dy2+a12_3*dy3+a12_4*dy4+a12_5*dy5 + &
         &  a12_6*dy6+a12_7*dy7+a12_8*dy8+a12_9*dy9+a12_10*dy10+a12_11*dy11)
  ! use y12 to get dy12
  CALL  dev(t,y12,dy12,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y13=y0+h*(a13_0*dy0+a13_1*dy1+a13_2*dy2+a13_3*dy3+a13_4*dy4+a13_5*dy5 + &
         &  a13_6*dy6+a13_7*dy7+a13_8*dy8+a13_9*dy9+a13_10*dy10+a13_11*dy11 + &
         &  a13_12*dy12)
  ! use y13 to get dy13
  CALL  dev(t,y13,dy13,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y14=y0+h*(a14_0*dy0+a14_1*dy1+a14_2*dy2+a14_3*dy3+a14_4*dy4+a14_5*dy5 + &
         &  a14_6*dy6+a14_7*dy7+a14_8*dy8+a14_9*dy9+a14_10*dy10+a14_11*dy11 + &
         &  a14_12*dy12+a14_13*dy13)
  ! use y14 to get dy14
  CALL  dev(t,y14,dy14,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y15=y0+h*(a15_0*dy0+a15_1*dy1+a15_2*dy2+a15_3*dy3+a15_4*dy4+a15_5*dy5 + &
         &  a15_6*dy6+a15_7*dy7+a15_8*dy8+a15_9*dy9+a15_10*dy10+a15_11*dy11 + &
         &  a15_12*dy12+a15_13*dy13+a15_14*dy14)
  ! use y15 to get dy15
  CALL  dev(t,y15,dy15,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y16=y0+h*(a16_0*dy0+a16_1*dy1+a16_2*dy2+a16_3*dy3+a16_4*dy4+a16_5*dy5 + &
         &  a16_6*dy6+a16_7*dy7+a16_8*dy8+a16_9*dy9+a16_10*dy10+a16_11*dy11 + &
         &  a16_12*dy12+a16_13*dy13+a16_14*dy14+a16_15*dy15)
  ! use y16 to get dy16
  CALL  dev(t,y16,dy16,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y17=y0+h*(a17_0*dy0+a17_1*dy1+a17_2*dy2+a17_3*dy3+a17_4*dy4+a17_5*dy5 + &
         &  a17_6*dy6+a17_7*dy7+a17_8*dy8+a17_9*dy9+a17_10*dy10+a17_11*dy11 + &
         &  a17_12*dy12+a17_13*dy13+a17_14*dy14+a17_15*dy15+a17_16*dy16)
  ! use y17 to get dy17
  CALL  dev(t,y17,dy17,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y18=y0+h*(a18_0*dy0+a18_1*dy1+a18_2*dy2+a18_3*dy3+a18_4*dy4+a18_5*dy5 + &
         &  a18_6*dy6+a18_7*dy7+a18_8*dy8+a18_9*dy9+a18_10*dy10+a18_11*dy11 + &
         &  a18_12*dy12+a18_13*dy13+a18_14*dy14+a18_15*dy15+a18_16*dy16+a18_17*dy17)
  ! use y18 to get dy18
  CALL  dev(t,y18,dy18,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y19=y0+h*(a19_0*dy0+a19_1*dy1+a19_2*dy2+a19_3*dy3+a19_4*dy4+a19_5*dy5 + &
         &  a19_6*dy6+a19_7*dy7+a19_8*dy8+a19_9*dy9+a19_10*dy10+a19_11*dy11 + &
         &  a19_12*dy12+a19_13*dy13+a19_14*dy14+a19_15*dy15+a19_16*dy16+a19_17*dy17 + &
         &  a19_18*dy18)
  ! use y19 to get dy19
  CALL  dev(t,y19,dy19,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y20=y0+h*(a20_0*dy0+a20_1*dy1+a20_2*dy2+a20_3*dy3+a20_4*dy4+a20_5*dy5 + &
         &  a20_6*dy6+a20_7*dy7+a20_8*dy8+a20_9*dy9+a20_10*dy10+a20_11*dy11 + &
         &  a20_12*dy12+a20_13*dy13+a20_14*dy14+a20_15*dy15+a20_16*dy16+a20_17*dy17 + &
         &  a20_18*dy18+a20_19*dy19)
  ! use y20 to get dy20
  CALL  dev(t,y20,dy20,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  yn=y0+h*(b0*dy0+b1*dy1+b2*dy2+b3*dy3+b4*dy4+b5*dy5+b6*dy6+b7*dy7 + &
        &  b8*dy8+b9*dy9+b10*dy10+b11*dy11+b12*dy12+b13*dy13+b14*dy14+b15*dy15 + &
        &  b16*dy16+b17*dy17+b18*dy18+b19*dy19+b20*dy20)
  ynp=y0+h*(b_0*dy0+b_1*dy1+b_2*dy2+b_3*dy3+b_4*dy4+b_5*dy5+b_6*dy6+b_7*dy7 + &
         &  b_8*dy8+b_9*dy9+b_10*dy10+b_11*dy11+b_12*dy12+b_13*dy13+b_14*dy14+b_15*dy15 + &
         &  b_16*dy16+b_17*dy17+b_18*dy18+b_19*dy19+b_20*dy20)
  yerr=h*((b0-b_0)*dy0+(b1-b_1)*dy1+(b2-b_2)*dy2+(b3-b_3)*dy3+(b4-b_4)*dy4 + &
       &  (b5-b_5)*dy5+(b6-b_6)*dy6+(b7-b_7)*dy7+(b8-b_8)*dy8+(b9-b_9)*dy9 + &
       &  (b10-b_10)*dy10+(b11-b_11)*dy11+(b12-b_12)*dy12+(b13-b_13)*dy13+(b14-b_14)*dy14 + &
       &  (b15-b_15)*dy15+(b16-b_16)*dy16+(b17-b_17)*dy17+(b18-b_18)*dy18+(b19-b_19)*dy19 + &
       &  (b20-b_20)*dy20)
  ! Find the max value of y among this step
  DO i = 1, SIZE(y0)
    ymax(i) = MAX(MAX(ABS(y0(i)), ABS(yn(i))), h*ABS(dy0(i)))
  END DO
  tolh = rtol*ymax + atol(1:SIZE(y0)) ! atol might be a longer array

  ! using the error to estimate the next step
  err = MAXVAL(ABS(yerr/tolh))
  IF (err.GT.1.D0) THEN
    rerun = .True.
    hnew = MAX(0.8D0*err**(-1.D0/10.D0), ReduceAtMost)*h ! no less than factor of ReduceAtMost
    ! PRINT *, 'Decrease time step by', 0.8D0*err**(-1.D0/10.D0),MAX(0.8D0*err**(-1.D0/10.D0), ReduceAtMost)
  ELSE
    rerun = .False.
    hnew = MIN(IncreaseAtMost, 0.8D0*err**(-1.D0/10.D0))*h ! no more than factor of IncreaseAtMost
    ! PRINT *, 'Increase time step by', 0.8D0*err**(-1.D0/10.D0),MIN(IncreaseAtMost,0.8D0*err**(-1.D0/10.D0))
  END IF

  ! adjust the step
  hnew = MAX(MIN(hnew,MaxStepSize),MinStepSize)
  IF (rerun) THEN
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) THEN ! h is already the min
      test = .True. ! stop the program
    ELSE
      hnew = MAX(MinStepSize,MIN(hnew, h*0.5D0)) ! if have not reduced, reduce to half
    END IF
    RETURN
  END IF

  ! check if any value have went crazy (Nan or Inf)
  DO i = 1, SIZE(y0)
    ! if any value is Nan or Inf, reRun this step
    IF (.NOT.IEEE_IS_NORMAL(yn(i))) THEN
      rerun = .True.
      IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) THEN ! h is already the min
        test = .True. ! stop the program
      ELSE
        hnew = MAX(MinStepSize,MIN(hnew, h*0.5D0)) ! if have not reduced, reduce to half
      END IF
      RETURN
    END IF
  END DO

  RETURN
END SUBROUTINE

END MODULE
