MODULE rk1211PeterMod

USE GlobalCommonMod
USE DyDtMod

IMPLICIT NONE
PRIVATE

!  Define access to SUBROUTINEs.

PUBLIC :: rk1211PeterEachStep
! downloaded from http://www.peterstone.name/Maplepgs/Maple/nmthds/RKcoeff/Runge_Kutta_schemes/RK12/RKcoeff12_n.pdf
! k[i] are the nodes 
REAL(KIND=8), PARAMETER, PRIVATE :: &
 k0=0.0D0,&
 k1=7.20822961095937922438483033585435597823345694733534014546422D-2,&
 k2=0.108123444164390688365772455037815339673501854210030102181963D0,&
 k3=0.162185166246586032548658682556723009510252781315045153272945D0,&
 k4=5.95935561016011400450665243503025065019608229711315367298266D-2,&
 k5=0.198151335408634970196961169877619206840181502069110705683372D0,&
 k6=9.49635592298487979984771021429348417274012835853366692048298D-2,&
 k7=0.147198248118605382874958280321026801918935104062426653197999D0,&
 k8=0.241476138179357862796052265038532477693798357000294957910487D0,&
 k9=6.4227875223762379650251667858534217142563516543272108728214D-2,&
 k10=0.167619047619047619047619047619047619047619047619047619047619D0,&
 k11=0.21710176789819525549950144587398106505973320845998255226909D0,&
 k12=0.251428571428571428571428571428571428571428571428571428571429D0,&
 k13=5.97759127715039115760312942085778679368408983257241335761059D-2,&
 k14=0.277816128061940358941843895319139717118994183360746916293652D0,&
 k15=0.146183591613978422090722314637247830008706454996337861427357D0,&
 k16=0.428672404383850710521747838105244903063371053811002606766033D0,&
 k17=0.526083674393600387731939049375307201588288177166856718780917D0,&
 k18=0.548582269010088432220878137959327787982319058360464128054629D0,&
 k19=0.51246763487106647924737598783968805627321115866291688218254D0,&
 k20=0.63217221135029354207436399217221135029354207436399217221135D0,&
 k21=0.133706928492034086698777324935161170804001482030381622823268D0,&
 k22=0.705411803118112807117786303158925801975348951106032160639948D0,&
 k23=0.233622596562872213714480176961034541432703760421984005444955D0,&
 k24=0.107740277251084987148695908650402393292040618548013314793747D0,&
 k25=0.912140204271123491179201485608170844939647168059424326833798D0,&
 k26=0.878275248028491477995421012465021622996692953446960061053167D0,&
 k27=0.980759093305218766473379019504480759093305218766473379019504D0,&
 k28=0.865891207663359562093739308929182346903865891207663359562094D0,&
 k29=1.0D0,&
 k30=1.0D0
! a[i,j] 
REAL(KIND=8), PARAMETER, PRIVATE :: &
 a1_0=7.20822961095937922438483033585435597823345694733534014546422D-2,&
 a2_0=2.70308610410976720914431137594538349183754635525075255454908D-2,&
 a2_1=8.10925831232930162743293412783615047551263906575225766364724D-2,&
 a3_0=4.05462915616465081371646706391807523775631953287612883182362D-2,&
 a3_1=0.0D0,&
 a3_2=0.121638874684939524411494011917542257132689585986283864954709D0,&
 a4_0=3.62450855786158455070273295650098469751198960782835056895238D-2,&
 a4_1=0.0D0,&
 a4_2=3.71996956719007304133156510223286139722266601682226044131636D-2,&
 a4_3=-1.38512251489154358752764562370359544453857332753745733728608D-2,&
 a5_0=1.5997348957700478195981934055711165659570402272605160961748D-2,&
 a5_1=0.0D0,&
 a5_2=0.0D0,&
 a5_3=8.55505829279321846856481758359583331303371151862647211206649D-2,&
 a5_4=9.66034035230023073153310599859497080502739846102408236009592D-2,&
 a6_0=2.07191059012818393317218338990833183181471087657260972832958D-2,&
 a6_1=0.0D0,&
 a6_2=0.0D0,&
 a6_3=0.0D0,&
 a6_4=7.36342544891031261949185685780962463658141236847434008477852D-2,&
 a6_5=6.10198839463832471836699665755277043440051134867171073748728D-4,&
 a7_0=2.63726553269292114330014879957232309866016807709615279261992D-2,&
 a7_1=0.0D0,&
 a7_2=0.0D0,&
 a7_3=0.0D0,&
 a7_4=3.28961369601776184604128022884363194854431072658303868019737D-2,&
 a7_5=5.07007974783379475910865225110788622282301591418841889573431D-3,&
 a7_6=8.28593760836647582224353377857593652240673001114463195740923D-2,&
 a8_0=2.84821688065157668675307987626637753625199895757957646825952D-2,&
 a8_1=0.0D0,&
 a8_2=0.0D0,&
 a8_3=0.0D0,&
 a8_4=0.0D0,&
 a8_5=0.116126792230470203300842742540522393735929309860662843672368D0,&
 a8_6=0.155337291182352196245071174078201404108241816754804549479533D0,&
 a8_7=-5.84701140399803036173924503428550955128927591909681999240086D-2,&
 a9_0=2.77560941770154682747870767829884949525925824475413674478784D-2,&
 a9_1=0.0D0,&
 a9_2=0.0D0,&
 a9_3=0.0D0,&
 a9_4=0.0D0,&
 a9_5=5.32197900703597544060593559028409735995439176573367662218955D-2,&
 a9_6=9.15326972053501439251978870283191662656697276348077322702231D-2,&
 a9_7=-9.51651926709912002767069746546727990648816030578992048779967D-2,&
 a9_8=-1.31155135579717866790856772009416186103611081385145523337863D-2,&
 a10_0=2.02654150145486951928441198745704844982973864666410137608635D-2,&
 a10_1=0.0D0,&
 a10_2=0.0D0,&
 a10_3=0.0D0,&
 a10_4=0.0D0,&
 a10_5=0.0D0,&
 a10_6=0.0D0,&
 a10_7=5.61671544878945357024160808575339440271085290253551179657076D-2,&
 a10_8=-4.30740010431556597330362999277055994119158022748741581119857D-4,&
 a10_9=9.16172181270359447496892098862202465163322901498002289021678D-2,&
 a11_0=1.9374975323845949602178407888983308167980469316931962560743D-2,&
 a11_1=0.0D0,&
 a11_2=0.0D0,&
 a11_3=0.0D0,&
 a11_4=0.0D0,&
 a11_5=0.0D0,&
 a11_6=0.0D0,&
 a11_7=0.0D0,&
 a11_8=5.78622857153141399102175728956183275090391941845863161456023D-3,&
 a11_9=9.67543130005836854857984243365919477197224998092818420330046D-2,&
 a11_10=9.51862510022342064205028563588439764211263199153101160607822D-2,&
 a12_0=1.93717355316804002126660548962604184485380609103676463407757D-2,&
 a12_1=0.0D0,&
 a12_2=0.0D0,&
 a12_3=0.0D0,&
 a12_4=0.0D0,&
 a12_5=0.0D0,&
 a12_6=0.0D0,&
 a12_7=0.0D0,&
 a12_8=2.93681981847288382618676121620661308919437808974413094603756D-2,&
 a12_9=9.67733817065703283592325268067550211983124182833763358174647D-2,&
 a12_10=9.48511682984647813706374574382904582999312079490414928527543D-2,&
 a12_11=1.10640877071270803670249201251993997327031033883446441000583D-2,&
 a13_0=2.17678103037271945166773352758089926635965754718425059709509D-2,&
 a13_1=0.0D0,&
 a13_2=0.0D0,&
 a13_3=0.0D0,&
 a13_4=0.0D0,&
 a13_5=0.0D0,&
 a13_6=0.0D0,&
 a13_7=0.0D0,&
 a13_8=-0.32049039924219128148347998721215686021085273475177746183017D0,&
 a13_9=5.33212899057310168894295518894671682403130579370345178257412D-2,&
 a13_10=-7.11037178676582545577892022546576859382897726363393177555298D-2,&
 a13_11=0.202080816361703340220023706011932129250454896016581915619177D0,&
 a13_12=0.174200113310191895991169890498184123931618876288381973745937D0,&
 a14_0=1.757620348689604356810335384545758506275277615075081583729D-2,&
 a14_1=0.0D0,&
 a14_2=0.0D0,&
 a14_3=0.0D0,&
 a14_4=0.0D0,&
 a14_5=0.0D0,&
 a14_6=0.0D0,&
 a14_7=0.0D0,&
 a14_8=0.0D0,&
 a14_9=0.0D0,&
 a14_10=0.114912300507463491898582157139717985581797886816560914435696D0,&
 a14_11=-1.62283120766236714857256436954043937189873554386157625240661D-2,&
 a14_12=6.88508676191369526637284522030617058783569237103703953889078D-2,&
 a14_13=9.27050685250675422971555758263068343150739521216805531558249D-2,&
 a15_0=1.76003296235244494790043167442200420615010579872750675884972D-2,&
 a15_1=0.0D0,&
 a15_2=0.0D0,&
 a15_3=0.0D0,&
 a15_4=0.0D0,&
 a15_5=0.0D0,&
 a15_6=0.0D0,&
 a15_7=0.0D0,&
 a15_8=0.0D0,&
 a15_9=0.0D0,&
 a15_10=6.72951594423823040317294541243391995245377692200024877692386D-2,&
 a15_11=-5.70984176782144879436669720144261634302221312123329754200576D-2,&
 a15_12=3.48279114829293038606758146047409683164101346770223902210527D-2,&
 a15_13=9.25041421136097095949093040663833733675239394419189965580249D-2,&
 a15_14=-8.94553337025285693192960288800958983104431511754810528939919D-3,&
 a16_0=0.233198066663621204937765816973768940287538616157844901233594D0,&
 a16_1=0.0D0,&
 a16_2=0.0D0,&
 a16_3=0.0D0,&
 a16_4=0.0D0,&
 a16_5=0.0D0,&
 a16_6=0.0D0,&
 a16_7=0.0D0,&
 a16_8=0.0D0,&
 a16_9=0.0D0,&
 a16_10=-46.5084716008474829450102379185569460400200055157205475866356D0,&
 a16_11=42.1335713215228956104124600637374515598949580950224040797503D0,&
 a16_12=-33.8539661923871392785076496236823489078544707132988452445221D0,&
 a16_13=-1.44481231333083768407102425253469495519615690789410212150402D0,&
 a16_14=11.4737304601300250859471359776605606264887920522687675489485D0,&
 a16_15=28.3954226626327687168132977745074536794627154272754810294953D0,&
 a17_0=0.267975705003499129291584059678058985953166557113663122054268D0,&
 a17_1=0.0D0,&
 a17_2=0.0D0,&
 a17_3=0.0D0,&
 a17_4=0.0D0,&
 a17_5=0.0D0,&
 a17_6=0.0D0,&
 a17_7=0.0D0,&
 a17_8=0.0D0,&
 a17_9=0.0D0,&
 a17_10=-13.8857149480435468818285539864839606763286436949314969674714D0,&
 a17_11=-4.54787410254031791707347122727318336605477529809664511373047D0,&
 a17_12=15.3469263254316876913526800336762710160693865080979606614956D0,&
 a17_13=-1.32312018099964839284857549877470238518953759108474467196713D0,&
 a17_14=-8.44394321919630658137489720826741827799693442802706424204435D0,&
 a17_15=12.7478996685087251434918614014104058395618556322919052419198D0,&
 a17_16=0.36393442622950819672131147540983606557377049180327868852459D0,&
 a18_0=1.92243461293266856633074591658887018973762416325658126641977D-2,&
 a18_1=0.0D0,&
 a18_2=0.0D0,&
 a18_3=0.0D0,&
 a18_4=0.0D0,&
 a18_5=0.0D0,&
 a18_6=0.0D0,&
 a18_7=0.0D0,&
 a18_8=0.0D0,&
 a18_9=0.0D0,&
 a18_10=0.0D0,&
 a18_11=0.0D0,&
 a18_12=0.0D0,&
 a18_13=8.26148554482360970202291065328314012798990287179681381107975D-2,&
 a18_14=0.155787779454858088317296325365501216392302811114378071200702D0,&
 a18_15=9.97107382774417513553372977822967697251512564155642501276671D-2,&
 a18_16=0.132779219498107603719196069370860902297262231961916430317956D0,&
 a18_17=5.8465330202118206145511879741948796390327488518071425633308D-2,&
 a19_0=1.92229964832470074667155229915444524018865941288681487831937D-2,&
 a19_1=0.0D0,&
 a19_2=0.0D0,&
 a19_3=0.0D0,&
 a19_4=0.0D0,&
 a19_5=0.0D0,&
 a19_6=0.0D0,&
 a19_7=0.0D0,&
 a19_8=0.0D0,&
 a19_9=0.0D0,&
 a19_10=0.0D0,&
 a19_11=0.0D0,&
 a19_12=0.0D0,&
 a19_13=8.26203002381220990954091654145692498632584573885800898306252D-2,&
 a19_14=0.155810177119717859933955377202930934786107054090762085796348D0,&
 a19_15=9.96999328321054839124640868651605886809123587772377953291263D-2,&
 a19_16=0.132630743588924790254339970927469787113029142663042841660711D0,&
 a19_17=3.01094629772358711695122947044022256034515502684515321382273D-2,&
 a19_18=-7.6259783682866325850204302663891821754339986540256113556914D-3,&
 a20_0=1.64643598399215383424958484142197899840857148297686766006687D-2,&
 a20_1=0.0D0,&
 a20_2=0.0D0,&
 a20_3=0.0D0,&
 a20_4=0.0D0,&
 a20_5=0.0D0,&
 a20_6=0.0D0,&
 a20_7=0.0D0,&
 a20_8=0.0D0,&
 a20_9=0.0D0,&
 a20_10=0.0D0,&
 a20_11=0.0D0,&
 a20_12=0.0D0,&
 a20_13=9.35911239338053470764989202954759502920915808224281727082387D-2,&
 a20_14=0.196637788612465339643027089783564754265702390047853619297661D0,&
 a20_15=7.85216644545640576104143465952270948486961463720211893286789D-2,&
 a20_16=-8.04738386185439415663999511327618797206450142995537320265198D-2,&
 a20_17=-4.31043005319247675464484099298103531829790333755754590672933D0,&
 a20_18=1.48163431668504554223488536914378605480229970074425518453411D0,&
 a20_19=3.15622684963551241337828336205373490411921489340476496849784D0,&
 a21_0=1.42554771028493571905512755617741961467076026432757772940321D-2,&
 a21_1=0.0D0,&
 a21_2=0.0D0,&
 a21_3=0.0D0,&
 a21_4=0.0D0,&
 a21_5=0.0D0,&
 a21_6=0.0D0,&
 a21_7=0.0D0,&
 a21_8=0.0D0,&
 a21_9=0.0D0,&
 a21_10=0.0D0,&
 a21_11=0.0D0,&
 a21_12=0.0D0,&
 a21_13=0.104570307565208372749668649143338558836837983087590359092651D0,&
 a21_14=4.99596771899512252908266217633006400596419009842984199243952D-2,&
 a21_15=-1.43016550747436562406848677135666936293134310189559074198562D-5,&
 a21_16=-0.261874496356192813166888885184580348532363199978401432512437D0,&
 a21_17=-4.81916858725424168946613213440533841134737029186095114373362D0,&
 a21_18=1.48401957368732582963506484209832585150458511290707351210725D0,&
 a21_19=3.5881981373922441987458135588296193132181834880350213254176D0,&
 a21_20=-2.623885918003565062388591800356506238859180035650623885918D-2,&
 a22_0=-2.24309235278322424350850930986519773164555382063383249751448D-3,&
 a22_1=0.0D0,&
 a22_2=0.0D0,&
 a22_3=0.0D0,&
 a22_4=0.0D0,&
 a22_5=0.0D0,&
 a22_6=0.0D0,&
 a22_7=0.0D0,&
 a22_8=0.0D0,&
 a22_9=0.0D0,&
 a22_10=0.0D0,&
 a22_11=0.0D0,&
 a22_12=0.0D0,&
 a22_13=0.127560435119312686422699060297386848330763137948489297092986D0,&
 a22_14=0.770754611769659557975405086985274992403803443488738468352441D0,&
 a22_15=-1.13793960225340177471194997337535456660478872565353285199891D0,&
 a22_16=-2.28732366904006120262545000880663720361021125401680841169049D0,&
 a22_17=-35.3311022489810727582778196082779744504773540602409259326586D0,&
 a22_18=9.92222470875286046454354232916237359889633166181146131161527D0,&
 a22_19=27.5828117540859271197596561644135149014649234975322485421218D0,&
 a22_20=8.17567477861419789965613839433889619096931798568792235897027D-2,&
 a22_21=0.978912158231529959278650378126817917393833624200116346713205D0,&
 a23_0=3.00906880706383014586866095327358076351199637768547589058853D-2,&
 a23_1=0.0D0,&
 a23_2=0.0D0,&
 a23_3=0.0D0,&
 a23_4=0.0D0,&
 a23_5=0.0D0,&
 a23_6=0.0D0,&
 a23_7=0.0D0,&
 a23_8=0.0D0,&
 a23_9=0.0D0,&
 a23_10=0.0D0,&
 a23_11=0.0D0,&
 a23_12=0.0D0,&
 a23_13=3.67889460062259025826831236095466587198338401964768960430944D-2,&
 a23_14=-4.25879646637249637159206228463519845046342999148693567802927D-2,&
 a23_15=6.82409038759354285487768220779558110307556675906330844359645D-2,&
 a23_16=0.207133421938029834292155309774793913601314365403438768394398D0,&
 a23_17=-1.62420924189175736212854885611907367667536985652994902591765D0,&
 a23_18=1.22845486996430392656807751147373788883222845486996430392657D0,&
 a23_19=0.355729164214613280420029379129768588635216217124311308739982D0,&
 a23_20=-0.142192720911322555095507420097358092425970865678175588986657D0,&
 a23_21=9.73311068972348795743356069396881102651911810488778196020717D-2,&
 a23_22=1.88434230626955412097127134855915163190190925344210370815889D-2,&
 a24_0=2.46571338847296581054554403873414037528767495538874032072306D-2,&
 a24_1=0.0D0,&
 a24_2=0.0D0,&
 a24_3=0.0D0,&
 a24_4=0.0D0,&
 a24_5=0.0D0,&
 a24_6=0.0D0,&
 a24_7=0.0D0,&
 a24_8=0.0D0,&
 a24_9=0.0D0,&
 a24_10=0.0D0,&
 a24_11=0.0D0,&
 a24_12=0.0D0,&
 a24_13=5.46019073779879190453038501483377965303444357709509932442077D-2,&
 a24_14=0.341851741014715535464025133488761652993928045252339456655368D0,&
 a24_15=0.127358249640619861288157200627604827906447960205497741443367D0,&
 a24_16=-0.297992372171541580727810836859222906547088784688896225329773D0,&
 a24_17=-2.67729962397580125934813363396545811640445148239985416260617D0,&
 a24_18=0.681686817563245195928150484268261134640662148739251153197483D0,&
 a24_19=2.21563048599864957642282762772694618699371029057842124303822D0,&
 a24_20=-1.83825836230362737522839985815609876669197683347241671661271D-3,&
 a24_21=-1.60159933773903998127769868903238235946407179116353281374188D-2,&
 a24_22=-7.31385860425231154111376428925870104230879829207120219940647D-4,&
 a24_23=-0.344168424481400660687162593994763794108825169889269422982223D0,&
 a25_0=-1.52966331189403370155306687768748282862877205458673125719939D0,&
 a25_1=0.0D0,&
 a25_2=0.0D0,&
 a25_3=0.0D0,&
 a25_4=0.0D0,&
 a25_5=0.0D0,&
 a25_6=0.0D0,&
 a25_7=0.0D0,&
 a25_8=0.0D0,&
 a25_9=0.0D0,&
 a25_10=0.0D0,&
 a25_11=0.0D0,&
 a25_12=0.0D0,&
 a25_13=0.473995545161746840229199750199036400045485074989559769873332D0,&
 a25_14=-64.4109166056425051421729428495580590337753463043256160255423D0,&
 a25_15=-26.937664587300218848327910364316636213225333184641687432053D0,&
 a25_16=14.3901572739635695998505647781143963830068359070186889938154D0,&
 a25_17=-53.3771575299872564538371808124326254266513062949392764102961D0,&
 a25_18=44.6730886974326766001309320661426395745644126098382579917048D0,&
 a25_19=9.97126306224443434802362562471603816447069513857337573830077D0,&
 a25_20=-10.317945433287173233845694728108795863320394856118850407324D0,&
 a25_21=-45.9596718377305214590801827734558974270820792431719028354777D0,&
 a25_22=3.19595212209946833562622363291307655316333443927461512372718D0,&
 a25_23=86.1329798985622519351457169794191310361063030025466569816612D0,&
 a25_24=44.6077229106486846709899170596633495262658129336023340956437D0,&
 a26_0=-2.34184674569259081770307839922628332839885695873425766630512D0,&
 a26_1=0.0D0,&
 a26_2=0.0D0,&
 a26_3=0.0D0,&
 a26_4=0.0D0,&
 a26_5=0.0D0,&
 a26_6=0.0D0,&
 a26_7=0.0D0,&
 a26_8=0.0D0,&
 a26_9=0.0D0,&
 a26_10=0.0D0,&
 a26_11=0.0D0,&
 a26_12=0.0D0,&
 a26_13=-1.71352423322812089050317240494366604056060432471856099848848D0,&
 a26_14=-110.017769506455774210138821081209764672669117617486312430043D0,&
 a26_15=-50.5039618521764229092111292900511499126146625874981826038187D0,&
 a26_16=13.9400026752426647318686036936837825338404482255982621365049D0,&
 a26_17=80.8908705896162249565570795108450018199724800394049154161305D0,&
 a26_18=-50.560701846523283382887929752612733465394595273501263978157D0,&
 a26_19=-35.5824202997374447285613328659436424605806101150789510897062D0,&
 a26_20=2.94092839551091741771740013584113276807333479072283189915866D0,&
 a26_21=-82.6108590443742053275455423571304576104538421095893136241992D0,&
 a26_22=1.04241049296616211424118737034179571949200012077926428219308D0,&
 a26_23=150.778690473385161166551295984162060627660681847299988581716D0,&
 a26_24=84.6346217224903931989043575585739753308647010448266280426383D0,&
 a26_25=-1.81655729951898412934970898650296862346641285780879065702154D-2,&
 a27_0=28.1954624710989331556349810947597592020296731864887716987874D0,&
 a27_1=0.0D0,&
 a27_2=0.0D0,&
 a27_3=0.0D0,&
 a27_4=0.0D0,&
 a27_5=0.0D0,&
 a27_6=0.0D0,&
 a27_7=0.0D0,&
 a27_8=0.0D0,&
 a27_9=0.0D0,&
 a27_10=0.0D0,&
 a27_11=0.0D0,&
 a27_12=0.0D0,&
 a27_13=18.320634865660869868078641926664553913321289812238554014197D0,&
 a27_14=1288.96259785674865646909331584919582002230869064787898543335D0,&
 a27_15=612.114736288315337104926374046039773556919458069125464631125D0,&
 a27_16=-127.87269585253456221198156682027649769585253456221198156682D0,&
 a27_17=-686.643835616438356164383561643835616438356164383561643835616D0,&
 a27_18=593.403703703703703703703703703703703703703703703703703703704D0,&
 a27_19=142.937632593913842684465088004820089040815992063918333514158D0,&
 a27_20=-56.2186515025615205530453414078490867809933211796974915754541D0,&
 a27_21=948.834581153293945190074691551969034635872357882845254223444D0,&
 a27_22=-3.94729727333711563405500450027703749924619100295553779453909D0,&
 a27_23=-1772.91707862624052754763923412437380610969201638144792398742D0,&
 a27_24=-985.173926316053047616708682073383004991339199623150121254179D0,&
 a27_25=0.177352474116444001310393990163881603836080158665012881137595D0,&
 a27_26=0.807542873618616316999579422182914595765486826927093293151377D0,&
 a28_0=-2.00238094238752793938825076112144761849078650914206500073351D0,&
 a28_1=0.0D0,&
 a28_2=0.0D0,&
 a28_3=0.0D0,&
 a28_4=0.0D0,&
 a28_5=0.0D0,&
 a28_6=0.0D0,&
 a28_7=0.0D0,&
 a28_8=0.0D0,&
 a28_9=0.0D0,&
 a28_10=0.0D0,&
 a28_11=0.0D0,&
 a28_12=0.0D0,&
 a28_13=-2.00138962483065324464140962601355845325569068374184296351133D0,&
 a28_14=-97.0057910561568726280265378734105606745275878371237232066898D0,&
 a28_15=-44.9799140813389245388891302734313356349939508441291675024675D0,&
 a28_16=10.9530985872580560348974614000316399866539751487010923403923D0,&
 a28_17=107.511468919585744485784443315574707986330389407636232717265D0,&
 a28_18=-67.8459319643119455393823207870543660506569766208086591349133D0,&
 a28_19=-45.8514462192048261963652181407735397747315439339513813301172D0,&
 a28_20=5.98702829985991206615963575133135376717856332086473512952204D0,&
 a28_21=-73.9762454489927997874345406176941904034222773041994960879747D0,&
 a28_22=0.249544188653878640886649965825184563717065008114250698924496D0,&
 a28_23=133.521037912769960595596188838870905478515276602486227039191D0,&
 a28_24=76.3106714981970943674468253063969758319171213627403629071778D0,&
 a28_25=-2.86866153923633723775310934337155005745185013455035212177403D-2,&
 a28_26=2.36227869332310556317482776097056276198923274345023689717774D-2,&
 a28_27=1.2049670213955621957256262214232156249149476720989057428395D-3,&
 a29_0=-16.0450689840976762440177355028517282090907935898339221399647D0,&
 a29_1=0.0D0,&
 a29_2=0.0D0,&
 a29_3=0.0D0,&
 a29_4=0.0D0,&
 a29_5=0.0D0,&
 a29_6=0.0D0,&
 a29_7=0.0D0,&
 a29_8=0.0D0,&
 a29_9=0.0D0,&
 a29_10=0.0D0,&
 a29_11=0.0D0,&
 a29_12=0.0D0,&
 a29_13=-15.2545947899387559766569762211850652426619268791734657947436D0,&
 a29_14=-757.804358608220417167360644046234139944039856332504714146734D0,&
 a29_15=-375.861157789005703457938963284846779079943576019705742794334D0,&
 a29_16=42.6311679468285276302222918719397501255334131666834972883599D0,&
 a29_17=679.993290107217115497480786486965237516010701735122207734295D0,&
 a29_18=-618.708578881121887417111151443069385942331238539883900010543D0,&
 a29_19=-102.628893018140992124374568929081887651743391857142221699182D0,&
 a29_20=85.0791211366160078136885347425572946613471822122662460764944D0,&
 a29_21=-559.943620178041543026706231454005934718100890207715133531157D0,&
 a29_22=-8.91681331892068169209891735332710130831924977691609654530064D0,&
 a29_23=1052.995337995337995337995337995337995337995337995337995338D0,&
 a29_24=595.312217174353721818793630695740619125010599672930059070535D0,&
 a29_25=1.55738699814282295207075806105096804803785583867897975858389D0,&
 a29_26=-6.71425090554460450388308648493156536251498335525224201265341D0,&
 a29_27=-3.58368891408239732557043945946582824245332024053175609821093D-2,&
 a29_28=5.34465200367689453315263926053638092723534913951377096933069D0,&
 a30_0=23.6748787546258544701499942866709388673628193130523760334548D0,&
 a30_1=0.0D0,&
 a30_2=0.0D0,&
 a30_3=0.0D0,&
 a30_4=0.0D0,&
 a30_5=0.0D0,&
 a30_6=0.0D0,&
 a30_7=0.0D0,&
 a30_8=0.0D0,&
 a30_9=0.0D0,&
 a30_10=0.0D0,&
 a30_11=0.0D0,&
 a30_12=0.0D0,&
 a30_13=10.4803993792143931143749662550336073811631437076559626551761D0,&
 a30_14=1058.02871068561595388180723262561195268431750190065016398859D0,&
 a30_15=491.607458468828553454866725231548253481008505621170719285417D0,&
 a30_16=-128.456612710514811209461885116610174470193711647587210975137D0,&
 a30_17=-262.287743690537552783080794448676126658255719164133695950342D0,&
 a30_18=243.223480128680794376390850329610446248107435555048046204197D0,&
 a30_19=46.7664697260753932762408468195916227558673574220353173529733D0,&
 a30_20=-3.91985553439850704832327374370556698032222669987541589030124D0,&
 a30_21=773.492708792698121536241009013600928289685649222722469486577D0,&
 a30_22=-12.2200369083584867620570672028503283246539461959467235410201D0,&
 a30_23=-1447.33281638106240536327749515400661800507661709580049172858D0,&
 a30_24=-793.19310370138337341884064178385396304388807574402479961998D0,&
 a30_25=1.36027460961598994282907324630830877186822721881095422339065D0,&
 a30_26=-3.82792186783593141783619165431145444559397045116868240881796D0,&
 a30_27=-5.2362818069133784920104904809381805285193024985858735880749D-2,&
 a30_28=3.65607306680514773489675620084755525388882006237686962028045D0,&
 a30_29=0.0D0
! b[i] are coefficients for nodes k[i] 
REAL(KIND=8), PARAMETER, PRIVATE :: &
 b0=2.52873393913019873709995928907132932950042009341219766490457D-2,&
 b1=0.0D0,&
 b2=0.0D0,&
 b3=0.0D0,&
 b4=0.0D0,&
 b5=0.0D0,&
 b6=0.0D0,&
 b7=0.0D0,&
 b8=0.0D0,&
 b9=0.0D0,&
 b10=0.0D0,&
 b11=0.0D0,&
 b12=0.0D0,&
 b13=0.0D0,&
 b14=0.0D0,&
 b15=0.0D0,&
 b16=0.0D0,&
 b17=0.0D0,&
 b18=-0.608595727434594366424180327866647922417080331809622240392886D0,&
 b19=0.689743630584370840055231384696706664459609228526933120638193D0,&
 b20=0.2536470013468783988093296762582976650862755319876843707507D0,&
 b21=-0.322802163722850606878580769594208559888235614457775927673183D0,&
 b22=8.42015536298932631067331346793917173744588698850529215815943D-2,&
 b23=0.270185520679968441244091887609256422399060485908321641995329D0,&
 b24=0.385385949072914591537526564581967790953684067378023547128239D0,&
 b25=0.252312044165594810307513864777849247336344494639210285735969D0,&
 b26=-0.730530853062781735695348604148753238187471989022903084494549D0,&
 b27=1.07030516932474294106637713258912914324836059373074273937385D-2,&
 b28=0.67356154844577992691775371312023750844867640660290389093038D0,&
 b29=1.69011052102770202382661116692981197071910434907420697574279D-2,&
 b30=0.0D0,&
 b_0=2.52069368183081442978987130980371953861252672175172608544112D-2,&
 b_1=0.0D0,&
 b_2=0.0D0,&
 b_3=0.0D0,&
 b_4=0.0D0,&
 b_5=0.0D0,&
 b_6=0.0D0,&
 b_7=0.0D0,&
 b_8=0.0D0,&
 b_9=0.0D0,&
 b_10=0.0D0,&
 b_11=0.0D0,&
 b_12=0.0D0,&
 b_13=0.0D0,&
 b_14=0.0D0,&
 b_15=0.0D0,&
 b_16=0.0D0,&
 b_17=0.0D0,&
 b_18=-0.559246060113628896361183958788543924494101311331741775874964D0,&
 b_19=0.658952680319387455053257810384377798030136927063997682795398D0,&
 b_20=0.225587378952966575707780401952615217024342759596574695821796D0,&
 b_21=-0.326686324702496661559396034845779695091099292652138650541993D0,&
 b_22=8.80113165935591035274636831933769184123183955859507003867041D-2,&
 b_23=0.272213556707123304331232555456036681023608334745317468809406D0,&
 b_24=0.388107787696038397483782590322167540688505303296163125119992D0,&
 b_25=0.453326305241980924391330779808342476316934627180232325446935D0,&
 b_26=-1.31538764377186215583879116404559360777212517136940678093981D0,&
 b_27=-4.05656862180544389010507209306900696386275783454854294370371D-2,&
 b_28=1.09047975247667824786767534439565347011398173901301937755916D0,&
 b_29=0.0D0,&
 b_30=4.0D-2


CONTAINS

SUBROUTINE rk1211PeterEachStep(y0,yn,h,hnew,rerun,test)
 REAL(KIND=8), DIMENSION(:), INTENT(IN) :: y0     ! y(t)
 REAL(KIND=8), DIMENSION(SIZE(y0)), INTENT(OUT) :: yn ! y(t+h)
 REAL(KIND=8), INTENT(IN) :: h ! initial step size
 REAL(KIND=8), INTENT(OUT) :: hnew       ! new step size
 LOGICAL, INTENT(OUT) :: test, rerun ! test=stop the program, rerun=re-run this step, reject
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: tolh ! the tolerance, determined by the problem
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: yerr ! the error between embedded method
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: ynp  ! the embedded
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: ymax ! the max value among y0 and yn
 REAL(KIND=8) :: err
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: y1,y2,y3,y4,y5,y6,y7,y8,y9, &
                                      y10,y11,y12,y13,y14,y15,y16,y17,y18, &
                                      y19,y20,y21,y22,y23,y24,y25,y26,y27, &
                                      y28,y29,y30
 REAL(KIND=8), DIMENSION(SIZE(y0)) :: dy0,dy1,dy2,dy3,dy4,dy5,dy6,dy7,dy8, &
                                      dy9,dy10,dy11,dy12,dy13,dy14,dy15,dy16,dy17, &
                                      dy18,dy19,dy20,dy21,dy22,dy23,dy24,dy25,dy26, &
                                      dy27,dy28,dy29,dy30
 INTEGER :: i
  test = .False.
  rerun = .False. 
  ! use y0 to get dy0
  CALL  dev(y0,dy0,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y1=y0+h*(a1_0*dy0)
  ! use y1 to get dy1
  CALL  dev(y1,dy1,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y2=y0+h*(a2_0*dy0+a2_1*dy1)
  ! use y2 to get dy2
  CALL  dev(y2,dy2,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y3=y0+h*(a3_0*dy0+a3_1*dy1+a3_2*dy2)
  ! use y3 to get dy3
  CALL  dev(y3,dy3,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y4=y0+h*(a4_0*dy0+a4_1*dy1+a4_2*dy2+a4_3*dy3)
  ! use y4 to get dy4
  CALL  dev(y4,dy4,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y5=y0+h*(a5_0*dy0+a5_1*dy1+a5_2*dy2+a5_3*dy3+a5_4*dy4)
  ! use y5 to get dy5
  CALL  dev(y5,dy5,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y6=y0+h*(a6_0*dy0+a6_1*dy1+a6_2*dy2+a6_3*dy3+a6_4*dy4+a6_5*dy5)
  ! use y6 to get dy6
  CALL  dev(y6,dy6,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y7=y0+h*(a7_0*dy0+a7_1*dy1+a7_2*dy2+a7_3*dy3+a7_4*dy4+a7_5*dy5 + &
        &  a7_6*dy6)
  ! use y7 to get dy7
  CALL  dev(y7,dy7,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y8=y0+h*(a8_0*dy0+a8_1*dy1+a8_2*dy2+a8_3*dy3+a8_4*dy4+a8_5*dy5 + &
        &  a8_6*dy6+a8_7*dy7)
  ! use y8 to get dy8
  CALL  dev(y8,dy8,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y9=y0+h*(a9_0*dy0+a9_1*dy1+a9_2*dy2+a9_3*dy3+a9_4*dy4+a9_5*dy5 + &
        &  a9_6*dy6+a9_7*dy7+a9_8*dy8)
  ! use y9 to get dy9
  CALL  dev(y9,dy9,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y10=y0+h*(a10_0*dy0+a10_1*dy1+a10_2*dy2+a10_3*dy3+a10_4*dy4+a10_5*dy5 + &
         &  a10_6*dy6+a10_7*dy7+a10_8*dy8+a10_9*dy9)
  ! use y10 to get dy10
  CALL  dev(y10,dy10,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y11=y0+h*(a11_0*dy0+a11_1*dy1+a11_2*dy2+a11_3*dy3+a11_4*dy4+a11_5*dy5 + &
         &  a11_6*dy6+a11_7*dy7+a11_8*dy8+a11_9*dy9+a11_10*dy10)
  ! use y11 to get dy11
  CALL  dev(y11,dy11,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y12=y0+h*(a12_0*dy0+a12_1*dy1+a12_2*dy2+a12_3*dy3+a12_4*dy4+a12_5*dy5 + &
         &  a12_6*dy6+a12_7*dy7+a12_8*dy8+a12_9*dy9+a12_10*dy10+a12_11*dy11)
  ! use y12 to get dy12
  CALL  dev(y12,dy12,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y13=y0+h*(a13_0*dy0+a13_1*dy1+a13_2*dy2+a13_3*dy3+a13_4*dy4+a13_5*dy5 + &
         &  a13_6*dy6+a13_7*dy7+a13_8*dy8+a13_9*dy9+a13_10*dy10+a13_11*dy11 + &
         &  a13_12*dy12)
  ! use y13 to get dy13
  CALL  dev(y13,dy13,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y14=y0+h*(a14_0*dy0+a14_1*dy1+a14_2*dy2+a14_3*dy3+a14_4*dy4+a14_5*dy5 + &
         &  a14_6*dy6+a14_7*dy7+a14_8*dy8+a14_9*dy9+a14_10*dy10+a14_11*dy11 + &
         &  a14_12*dy12+a14_13*dy13)
  ! use y14 to get dy14
  CALL  dev(y14,dy14,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y15=y0+h*(a15_0*dy0+a15_1*dy1+a15_2*dy2+a15_3*dy3+a15_4*dy4+a15_5*dy5 + &
         &  a15_6*dy6+a15_7*dy7+a15_8*dy8+a15_9*dy9+a15_10*dy10+a15_11*dy11 + &
         &  a15_12*dy12+a15_13*dy13+a15_14*dy14)
  ! use y15 to get dy15
  CALL  dev(y15,dy15,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y16=y0+h*(a16_0*dy0+a16_1*dy1+a16_2*dy2+a16_3*dy3+a16_4*dy4+a16_5*dy5 + &
         &  a16_6*dy6+a16_7*dy7+a16_8*dy8+a16_9*dy9+a16_10*dy10+a16_11*dy11 + &
         &  a16_12*dy12+a16_13*dy13+a16_14*dy14+a16_15*dy15)
  ! use y16 to get dy16
  CALL  dev(y16,dy16,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y17=y0+h*(a17_0*dy0+a17_1*dy1+a17_2*dy2+a17_3*dy3+a17_4*dy4+a17_5*dy5 + &
         &  a17_6*dy6+a17_7*dy7+a17_8*dy8+a17_9*dy9+a17_10*dy10+a17_11*dy11 + &
         &  a17_12*dy12+a17_13*dy13+a17_14*dy14+a17_15*dy15+a17_16*dy16)
  ! use y17 to get dy17
  CALL  dev(y17,dy17,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y18=y0+h*(a18_0*dy0+a18_1*dy1+a18_2*dy2+a18_3*dy3+a18_4*dy4+a18_5*dy5 + &
         &  a18_6*dy6+a18_7*dy7+a18_8*dy8+a18_9*dy9+a18_10*dy10+a18_11*dy11 + &
         &  a18_12*dy12+a18_13*dy13+a18_14*dy14+a18_15*dy15+a18_16*dy16+a18_17*dy17)
  ! use y18 to get dy18
  CALL  dev(y18,dy18,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y19=y0+h*(a19_0*dy0+a19_1*dy1+a19_2*dy2+a19_3*dy3+a19_4*dy4+a19_5*dy5 + &
         &  a19_6*dy6+a19_7*dy7+a19_8*dy8+a19_9*dy9+a19_10*dy10+a19_11*dy11 + &
         &  a19_12*dy12+a19_13*dy13+a19_14*dy14+a19_15*dy15+a19_16*dy16+a19_17*dy17 + &
         &  a19_18*dy18)
  ! use y19 to get dy19
  CALL  dev(y19,dy19,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y20=y0+h*(a20_0*dy0+a20_1*dy1+a20_2*dy2+a20_3*dy3+a20_4*dy4+a20_5*dy5 + &
         &  a20_6*dy6+a20_7*dy7+a20_8*dy8+a20_9*dy9+a20_10*dy10+a20_11*dy11 + &
         &  a20_12*dy12+a20_13*dy13+a20_14*dy14+a20_15*dy15+a20_16*dy16+a20_17*dy17 + &
         &  a20_18*dy18+a20_19*dy19)
  ! use y20 to get dy20
  CALL  dev(y20,dy20,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y21=y0+h*(a21_0*dy0+a21_1*dy1+a21_2*dy2+a21_3*dy3+a21_4*dy4+a21_5*dy5 + &
         &  a21_6*dy6+a21_7*dy7+a21_8*dy8+a21_9*dy9+a21_10*dy10+a21_11*dy11 + &
         &  a21_12*dy12+a21_13*dy13+a21_14*dy14+a21_15*dy15+a21_16*dy16+a21_17*dy17 + &
         &  a21_18*dy18+a21_19*dy19+a21_20*dy20)
  ! use y21 to get dy21
  CALL  dev(y21,dy21,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y22=y0+h*(a22_0*dy0+a22_1*dy1+a22_2*dy2+a22_3*dy3+a22_4*dy4+a22_5*dy5 + &
         &  a22_6*dy6+a22_7*dy7+a22_8*dy8+a22_9*dy9+a22_10*dy10+a22_11*dy11 + &
         &  a22_12*dy12+a22_13*dy13+a22_14*dy14+a22_15*dy15+a22_16*dy16+a22_17*dy17 + &
         &  a22_18*dy18+a22_19*dy19+a22_20*dy20+a22_21*dy21)
  ! use y22 to get dy22
  CALL  dev(y22,dy22,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y23=y0+h*(a23_0*dy0+a23_1*dy1+a23_2*dy2+a23_3*dy3+a23_4*dy4+a23_5*dy5 + &
         &  a23_6*dy6+a23_7*dy7+a23_8*dy8+a23_9*dy9+a23_10*dy10+a23_11*dy11 + &
         &  a23_12*dy12+a23_13*dy13+a23_14*dy14+a23_15*dy15+a23_16*dy16+a23_17*dy17 + &
         &  a23_18*dy18+a23_19*dy19+a23_20*dy20+a23_21*dy21+a23_22*dy22)
  ! use y23 to get dy23
  CALL  dev(y23,dy23,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y24=y0+h*(a24_0*dy0+a24_1*dy1+a24_2*dy2+a24_3*dy3+a24_4*dy4+a24_5*dy5 + &
         &  a24_6*dy6+a24_7*dy7+a24_8*dy8+a24_9*dy9+a24_10*dy10+a24_11*dy11 + &
         &  a24_12*dy12+a24_13*dy13+a24_14*dy14+a24_15*dy15+a24_16*dy16+a24_17*dy17 + &
         &  a24_18*dy18+a24_19*dy19+a24_20*dy20+a24_21*dy21+a24_22*dy22+a24_23*dy23)
  ! use y24 to get dy24
  CALL  dev(y24,dy24,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y25=y0+h*(a25_0*dy0+a25_1*dy1+a25_2*dy2+a25_3*dy3+a25_4*dy4+a25_5*dy5 + &
         &  a25_6*dy6+a25_7*dy7+a25_8*dy8+a25_9*dy9+a25_10*dy10+a25_11*dy11 + &
         &  a25_12*dy12+a25_13*dy13+a25_14*dy14+a25_15*dy15+a25_16*dy16+a25_17*dy17 + &
         &  a25_18*dy18+a25_19*dy19+a25_20*dy20+a25_21*dy21+a25_22*dy22+a25_23*dy23 + &
         &  a25_24*dy24)
  ! use y25 to get dy25
  CALL  dev(y25,dy25,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y26=y0+h*(a26_0*dy0+a26_1*dy1+a26_2*dy2+a26_3*dy3+a26_4*dy4+a26_5*dy5 + &
         &  a26_6*dy6+a26_7*dy7+a26_8*dy8+a26_9*dy9+a26_10*dy10+a26_11*dy11 + &
         &  a26_12*dy12+a26_13*dy13+a26_14*dy14+a26_15*dy15+a26_16*dy16+a26_17*dy17 + &
         &  a26_18*dy18+a26_19*dy19+a26_20*dy20+a26_21*dy21+a26_22*dy22+a26_23*dy23 + &
         &  a26_24*dy24+a26_25*dy25)
  ! use y26 to get dy26
  CALL  dev(y26,dy26,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y27=y0+h*(a27_0*dy0+a27_1*dy1+a27_2*dy2+a27_3*dy3+a27_4*dy4+a27_5*dy5 + &
         &  a27_6*dy6+a27_7*dy7+a27_8*dy8+a27_9*dy9+a27_10*dy10+a27_11*dy11 + &
         &  a27_12*dy12+a27_13*dy13+a27_14*dy14+a27_15*dy15+a27_16*dy16+a27_17*dy17 + &
         &  a27_18*dy18+a27_19*dy19+a27_20*dy20+a27_21*dy21+a27_22*dy22+a27_23*dy23 + &
         &  a27_24*dy24+a27_25*dy25+a27_26*dy26)
  ! use y27 to get dy27
  CALL  dev(y27,dy27,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y28=y0+h*(a28_0*dy0+a28_1*dy1+a28_2*dy2+a28_3*dy3+a28_4*dy4+a28_5*dy5 + &
         &  a28_6*dy6+a28_7*dy7+a28_8*dy8+a28_9*dy9+a28_10*dy10+a28_11*dy11 + &
         &  a28_12*dy12+a28_13*dy13+a28_14*dy14+a28_15*dy15+a28_16*dy16+a28_17*dy17 + &
         &  a28_18*dy18+a28_19*dy19+a28_20*dy20+a28_21*dy21+a28_22*dy22+a28_23*dy23 + &
         &  a28_24*dy24+a28_25*dy25+a28_26*dy26+a28_27*dy27)
  ! use y28 to get dy28
  CALL  dev(y28,dy28,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y29=y0+h*(a29_0*dy0+a29_1*dy1+a29_2*dy2+a29_3*dy3+a29_4*dy4+a29_5*dy5 + &
         &  a29_6*dy6+a29_7*dy7+a29_8*dy8+a29_9*dy9+a29_10*dy10+a29_11*dy11 + &
         &  a29_12*dy12+a29_13*dy13+a29_14*dy14+a29_15*dy15+a29_16*dy16+a29_17*dy17 + &
         &  a29_18*dy18+a29_19*dy19+a29_20*dy20+a29_21*dy21+a29_22*dy22+a29_23*dy23 + &
         &  a29_24*dy24+a29_25*dy25+a29_26*dy26+a29_27*dy27+a29_28*dy28)
  ! use y29 to get dy29
  CALL  dev(y29,dy29,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  y30=y0+h*(a30_0*dy0+a30_1*dy1+a30_2*dy2+a30_3*dy3+a30_4*dy4+a30_5*dy5 + &
         &  a30_6*dy6+a30_7*dy7+a30_8*dy8+a30_9*dy9+a30_10*dy10+a30_11*dy11 + &
         &  a30_12*dy12+a30_13*dy13+a30_14*dy14+a30_15*dy15+a30_16*dy16+a30_17*dy17 + &
         &  a30_18*dy18+a30_19*dy19+a30_20*dy20+a30_21*dy21+a30_22*dy22+a30_23*dy23 + &
         &  a30_24*dy24+a30_25*dy25+a30_26*dy26+a30_27*dy27+a30_28*dy28+a30_29*dy29)
  ! use y30 to get dy30
  CALL  dev(y30,dy30,test)
  IF (test) THEN ! bad dy 
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) RETURN ! stop the program 
    hnew = MAX(MIN(h/2.D0,MaxStepSize),MinStepSize) ! reduce step 
    rerun = .True.
    test = .False.
    RETURN
  END IF

  yn=y0+h*(b0*dy0+b1*dy1+b2*dy2+b3*dy3+b4*dy4+b5*dy5+b6*dy6+b7*dy7 + &
        &  b8*dy8+b9*dy9+b10*dy10+b11*dy11+b12*dy12+b13*dy13+b14*dy14+b15*dy15 + &
        &  b16*dy16+b17*dy17+b18*dy18+b19*dy19+b20*dy20+b21*dy21+b22*dy22+b23*dy23 + &
        &  b24*dy24+b25*dy25+b26*dy26+b27*dy27+b28*dy28+b29*dy29+b30*dy30)
  ynp=y0+h*(b_0*dy0+b_1*dy1+b_2*dy2+b_3*dy3+b_4*dy4+b_5*dy5+b_6*dy6+b_7*dy7 + &
         &  b_8*dy8+b_9*dy9+b_10*dy10+b_11*dy11+b_12*dy12+b_13*dy13+b_14*dy14+b_15*dy15 + &
         &  b_16*dy16+b_17*dy17+b_18*dy18+b_19*dy19+b_20*dy20+b_21*dy21+b_22*dy22+b_23*dy23 + &
         &  b_24*dy24+b_25*dy25+b_26*dy26+b_27*dy27+b_28*dy28+b_29*dy29+b_30*dy30)
  yerr=h*((b0-b_0)*dy0+(b1-b_1)*dy1+(b2-b_2)*dy2+(b3-b_3)*dy3+(b4-b_4)*dy4 + &
       &  (b5-b_5)*dy5+(b6-b_6)*dy6+(b7-b_7)*dy7+(b8-b_8)*dy8+(b9-b_9)*dy9 + &
       &  (b10-b_10)*dy10+(b11-b_11)*dy11+(b12-b_12)*dy12+(b13-b_13)*dy13+(b14-b_14)*dy14 + &
       &  (b15-b_15)*dy15+(b16-b_16)*dy16+(b17-b_17)*dy17+(b18-b_18)*dy18+(b19-b_19)*dy19 + &
       &  (b20-b_20)*dy20+(b21-b_21)*dy21+(b22-b_22)*dy22+(b23-b_23)*dy23+(b24-b_24)*dy24 + &
       &  (b25-b_25)*dy25+(b26-b_26)*dy26+(b27-b_27)*dy27+(b28-b_28)*dy28+(b29-b_29)*dy29 + &
       &  (b30-b_30)*dy30)
  ! Find the max value of y among this step
  DO i = 1, SIZE(y0)
    ymax(i) = MAX(MAX(ABS(y0(i)), ABS(yn(i))), h*ABS(dy0(i)))
  END DO
  tolh = rtol*ymax + atol(1:SIZE(y0)) ! atol might be a longer array

  ! using the error to estimate the next step
  err = MAXVAL(ABS(yerr/tolh))
  IF (err.GT.1.D0) THEN
    rerun = .True.
    hnew = MAX(0.8D0*err**(-8.3333333333333D-02), 0.1D0)*h ! no less than factor of 0.1
    ! PRINT *, 'Decrease time step by', 0.8D0*err**(-8.3333333333333D-02),MAX(0.8D0*err**(-8.3333333333333D-02), 0.1D0)
  ELSE
    rerun = .False.
    hnew = MIN(5.D0, 0.8D0*err**(-8.3333333333333D-02))*h ! no more than factor of 5
    ! PRINT *, 'Increase time step by', 0.8D0*err**(-8.3333333333333D-02),MIN(5.D0,0.8D0*err**(-8.3333333333333D-02))
  END IF

  ! adjust the step
  hnew = MAX(MIN(hnew,MaxStepSize),MinStepSize)
  IF (rerun) THEN
    IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) THEN ! h is already the min
      test = .True. ! stop the program
    ELSE
      hnew = MAX(MinStepSize,MIN(hnew, h*0.5D0)) ! if have not reduced, reduce to half
    END IF
    RETURN
  END IF

  ! check if any value have went crazy (Nan or Inf)
  DO i = 1, SIZE(y0)
    CALL checkNanInf(yn(i), rerun)
    IF (rerun) THEN
      IF (ABS(h-MinStepSize)/MinStepSize.LE.1D-13) THEN ! h is already the min
        test = .True. ! stop the program
      ELSE
        hnew = MAX(MinStepSize,MIN(hnew, h*0.5D0)) ! if have not reduced, reduce to half
      END IF
      RETURN
    END IF
  END DO

  RETURN
END SUBROUTINE

END MODULE
